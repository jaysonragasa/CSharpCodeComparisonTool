<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C# Code Comparator (Monaco)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- JSDiff (Still used for Method logic analysis) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>

    <style>
        /* Container sizes for Monaco */
        .monaco-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Custom Scrollbar for non-editor parts */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Loading Overlay */
        #loader {
            position: fixed; inset: 0; background: #0f172a; z-index: 50; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-family: sans-serif; flex-direction: column; gap: 10px;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 h-screen flex flex-col font-sans overflow-hidden transition-colors duration-200">

    <!-- Initial Loader -->
    <div id="loader">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
        <div class="text-sm opacity-80">Loading Editor...</div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 md:px-6 py-3 flex items-center justify-between shrink-0 shadow-sm z-10 transition-colors duration-200">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg text-white">
                <i data-lucide="file-diff" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800 dark:text-white">C# Comparator</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-2 md:gap-4">
            
            <div class="flex items-center bg-slate-100 dark:bg-slate-700 p-1 rounded-lg border border-slate-200 dark:border-slate-600">
                <button id="mode-full" onclick="setMode('full')" class="px-3 py-1.5 rounded-md text-xs md:text-sm font-medium transition-all shadow-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-300">
                    Full File
                </button>
                <button id="mode-methods" onclick="setMode('methods')" class="px-3 py-1.5 rounded-md text-xs md:text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-300 transition-all">
                    Methods
                </button>
            </div>

            <button onclick="toggleTheme()" class="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors" title="Toggle Theme">
                <i id="theme-icon" data-lucide="sun" class="w-5 h-5"></i>
            </button>

            <button onclick="compare()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 md:px-5 py-2 rounded-lg text-sm font-medium shadow-sm transition-colors flex items-center gap-2">
                <i data-lucide="play" class="w-4 h-4"></i> <span class="hidden md:inline">Compare</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Input Area -->
        <!-- Added min-w-0 to allow flex container to shrink below content size -->
        <div id="input-container" class="flex-1 min-w-0 flex flex-col md:flex-row border-r border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 transition-colors">
            
            <!-- Left Pane (Original) -->
            <div class="flex-1 flex flex-col border-b md:border-b-0 md:border-r border-slate-200 dark:border-slate-700 relative group min-w-0">
                <div class="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-2 flex justify-between items-center text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider transition-colors">
                    <span>Source A (Original)</span>
                    <label class="cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400 flex items-center gap-1">
                        <i data-lucide="upload" class="w-3 h-3"></i> Load
                        <input type="file" onchange="loadFile(this, 1)" accept=".cs,.txt" class="hidden">
                    </label>
                </div>
                
                <!-- Monaco Container 1 -->
                <div id="editor1" class="monaco-container"></div>
            </div>

            <!-- Right Pane (Modified) -->
            <div class="flex-1 flex flex-col relative group min-w-0">
                <div class="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-2 flex justify-between items-center text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider transition-colors">
                    <span>Source B (Modified)</span>
                    <label class="cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400 flex items-center gap-1">
                        <i data-lucide="upload" class="w-3 h-3"></i> Load
                        <input type="file" onchange="loadFile(this, 2)" accept=".cs,.txt" class="hidden">
                    </label>
                </div>
                
                <!-- Monaco Container 2 -->
                <div id="editor2" class="monaco-container"></div>
            </div>
        </div>

        <!-- Output Area -->
        <div id="output-panel" class="w-0 bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-700 flex flex-col transition-all duration-300 ease-in-out">
            <div class="bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-4 py-3 flex justify-between items-center shrink-0">
                <h2 class="font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                    <i data-lucide="git-compare" class="w-4 h-4 text-indigo-600 dark:text-indigo-400"></i> Comparison
                </h2>
                <button onclick="closeOutput()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="results-container" class="flex-1 overflow-hidden relative bg-white dark:bg-[#1e1e1e]">
                <!-- Results injected here -->
                <div id="placeholder-msg" class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i data-lucide="activity" class="w-10 h-10 mb-2 opacity-50"></i>
                    <p>Run comparison to see results</p>
                </div>
                <!-- Monaco Diff Editor will mount here -->
                <div id="diff-editor" class="monaco-container hidden"></div>
                <!-- Method List will mount here -->
                <div id="method-list" class="w-full h-full overflow-auto hidden"></div>
            </div>
        </div>

    </main>

    <!-- Modal for Method Diff Detail -->
    <div id="method-modal" class="fixed inset-0 z-50 hidden bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1e1e1e] rounded-xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col border border-slate-200 dark:border-slate-700">
            <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <h3 id="modal-title" class="font-bold text-lg text-slate-800 dark:text-slate-100 font-mono text-sm">Method Diff</h3>
                <button onclick="closeModal()" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500 dark:text-slate-400"></i>
                </button>
            </div>
            <div class="flex-1 overflow-hidden relative">
                <div id="modal-diff-editor" class="monaco-container"></div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let currentMode = 'full';
        let isDarkMode = true;
        
        // Monaco Instances
        let editor1 = null;
        let editor2 = null;
        let diffEditor = null; // Main results diff
        let modalDiffEditor = null; // Modal diff
        
        // --- Monaco Initialization ---
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});

        // Initialize
        require(['vs/editor/editor.main'], function() {
            initEditors();
            document.getElementById('loader').style.display = 'none';
            lucide.createIcons();
        });

        function initEditors() {
            const theme = isDarkMode ? 'vs-dark' : 'vs';
            const commonOptions = {
                language: 'csharp',
                theme: theme,
                automaticLayout: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                fontSize: 14
            };

            // Input Editors
            editor1 = monaco.editor.create(document.getElementById('editor1'), {
                ...commonOptions,
                value: '// Paste C# Source A here...'
            });

            editor2 = monaco.editor.create(document.getElementById('editor2'), {
                ...commonOptions,
                value: '// Paste C# Source B here...'
            });

            // Sync scrolling logic for inputs
            // We use a flag to prevent infinite scroll loops
            let isSyncing = false;
            editor1.onDidScrollChange((e) => {
                if(!isSyncing) {
                    isSyncing = true;
                    editor2.setScrollTop(e.scrollTop);
                    editor2.setScrollLeft(e.scrollLeft);
                    isSyncing = false;
                }
            });
            editor2.onDidScrollChange((e) => {
                if(!isSyncing) {
                    isSyncing = true;
                    editor1.setScrollTop(e.scrollTop);
                    editor1.setScrollLeft(e.scrollLeft);
                    isSyncing = false;
                }
            });

            // Output Diff Editor
            diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-editor'), {
                ...commonOptions,
                readOnly: true,
                originalEditable: false,
                renderSideBySide: true
            });
            
            // Modal Diff Editor
            modalDiffEditor = monaco.editor.createDiffEditor(document.getElementById('modal-diff-editor'), {
                ...commonOptions,
                readOnly: true,
                originalEditable: false,
                renderSideBySide: true
            });
        }

        // --- UI & Logic ---

        function toggleTheme() {
            const html = document.documentElement;
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                html.classList.add('dark');
                html.classList.remove('light');
                document.getElementById('theme-icon').setAttribute('data-lucide', 'sun');
                monaco.editor.setTheme('vs-dark');
            } else {
                html.classList.remove('dark');
                html.classList.add('light');
                document.getElementById('theme-icon').setAttribute('data-lucide', 'moon');
                monaco.editor.setTheme('vs');
            }
            lucide.createIcons();
        }

        function setMode(mode) {
            currentMode = mode;
            const btnFull = document.getElementById('mode-full');
            const btnMethods = document.getElementById('mode-methods');
            const activeClass = "px-3 py-1.5 rounded-md text-xs md:text-sm font-medium transition-all shadow-sm bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-300";
            const inactiveClass = "px-3 py-1.5 rounded-md text-xs md:text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-300 transition-all";

            if (mode === 'full') {
                btnFull.className = activeClass;
                btnMethods.className = inactiveClass;
            } else {
                btnMethods.className = activeClass;
                btnFull.className = inactiveClass;
            }
        }

        function loadFile(input, editorNum) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const editor = editorNum === 1 ? editor1 : editor2;
                editor.setValue(text);
            };
            reader.readAsText(file);
        }

        function closeOutput() {
            const panel = document.getElementById('output-panel');
            const inputContainer = document.getElementById('input-container');
            panel.classList.remove('w-[50%]', 'w-full');
            panel.classList.add('w-0');
            inputContainer.classList.remove('hidden');
        }

        function openOutput() {
            const panel = document.getElementById('output-panel');
            const inputContainer = document.getElementById('input-container');
            
            panel.classList.remove('w-0');
            
            if (window.innerWidth < 768) {
                panel.classList.add('w-full');
                inputContainer.classList.add('hidden'); // Hide input on mobile
            } else {
                panel.classList.add('w-[50%]');
            }

            // Trigger layout update for Monaco after resize animation
            // Also refresh input editors so they shrink correctly
            setTimeout(() => {
                if(diffEditor) diffEditor.layout();
                if(editor1) editor1.layout();
                if(editor2) editor2.layout();
            }, 300);
        }

        // --- Core Comparison ---

        function compare() {
            openOutput();
            
            const code1 = editor1.getValue();
            const code2 = editor2.getValue();

            const diffDiv = document.getElementById('diff-editor');
            const listDiv = document.getElementById('method-list');
            const placeholder = document.getElementById('placeholder-msg');

            placeholder.style.display = 'none';

            if (currentMode === 'full') {
                listDiv.style.display = 'none';
                diffDiv.style.display = 'block';
                diffDiv.classList.remove('hidden');
                
                // Set models for Diff Editor
                diffEditor.setModel({
                    original: monaco.editor.createModel(code1, 'csharp'),
                    modified: monaco.editor.createModel(code2, 'csharp')
                });
                diffEditor.layout(); // Refresh layout
            } else {
                diffDiv.style.display = 'none';
                listDiv.style.display = 'block';
                listDiv.classList.remove('hidden');
                
                renderMethodList(code1, code2, listDiv);
            }
        }

        // --- Method Mode Logic ---

        function renderMethodList(text1, text2, container) {
            // Using logic similar to previous version, but updated UI
            const methods1 = extractMethods(text1);
            const methods2 = extractMethods(text2);
            
            const map1 = new Map(methods1.map(m => [m.signature, m]));
            const map2 = new Map(methods2.map(m => [m.signature, m]));
            
            const allSigs = new Set([...map1.keys(), ...map2.keys()]);
            const sortedSigs = Array.from(allSigs).sort();

            if (sortedSigs.length === 0) {
                 container.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 text-slate-500 dark:text-slate-400">
                        <i data-lucide="search-x" class="w-10 h-10 mb-2"></i>
                        <p>No methods found.</p>
                    </div>`;
                 lucide.createIcons();
                 return;
            }

            let html = `<div class="p-4 space-y-3">`;

            sortedSigs.forEach(sig => {
                const m1 = map1.get(sig);
                const m2 = map2.get(sig);
                
                let status = '';
                let badgeClass = '';
                let icon = '';
                let isModified = false;

                if (!m1 && m2) {
                    status = 'Added';
                    badgeClass = 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/40 dark:text-green-300 dark:border-green-800';
                    icon = 'plus-circle';
                    isModified = true;
                } else if (m1 && !m2) {
                    status = 'Removed';
                    badgeClass = 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/40 dark:text-red-300 dark:border-red-800';
                    icon = 'minus-circle';
                    isModified = true;
                } else if (m1 && m2) {
                    if (m1.body.trim() !== m2.body.trim()) {
                        status = 'Modified';
                        badgeClass = 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/40 dark:text-amber-300 dark:border-amber-800';
                        icon = 'pencil';
                        isModified = true;
                    } else {
                        status = 'Identical';
                        badgeClass = 'bg-slate-100 text-slate-500 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700';
                        icon = 'check-circle';
                    }
                }

                if (isModified) {
                    // Store data in data attribute for onClick
                    // Careful with quotes in signature, using simplified escape
                    const safeSig = sig.replace(/"/g, '&quot;');
                    html += `
                        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 hover:shadow-md transition-shadow cursor-pointer flex items-center justify-between group" onclick="openMethodDetail('${escapeHtml(sig)}')">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <span class="px-2 py-1 rounded-md text-xs font-bold border ${badgeClass} shrink-0 flex items-center gap-1 w-24 justify-center">
                                    <i data-lucide="${icon}" class="w-3 h-3"></i> ${status}
                                </span>
                                <code class="text-sm font-semibold text-slate-700 dark:text-slate-300 truncate font-mono" title="${escapeHtml(sig)}">${escapeHtml(sig)}</code>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400 group-hover:text-indigo-600 dark:group-hover:text-indigo-400"></i>
                        </div>
                    `;
                }
            });
            
            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
            
            // Save data for modal
            window.lastMethodData = { map1, map2 };
        }

        // --- Parsing Helpers (Same as before) ---
        function extractMethods(source) {
            const methods = [];
            const methodRegex = /((?:public|private|protected|internal|static|virtual|override|abstract|async|\s)+[\w<>[\]]+\s+(\w+)\s*\((?:[^)]*)\))\s*(?:where\s+[\w\s:<>,]+)?\s*\{/g;
            let match;
            while ((match = methodRegex.exec(source)) !== null) {
                const fullSig = match[1].trim().replace(/\s+/g, ' '); 
                const startIndex = match.index;
                const bodyEndIndex = findMatchingBrace(source, source.indexOf('{', startIndex));
                if (bodyEndIndex !== -1) {
                    const fullText = source.substring(startIndex, bodyEndIndex + 1);
                    const bodyOnly = source.substring(source.indexOf('{', startIndex), bodyEndIndex + 1);
                    if (!fullSig.includes("class ") && !fullSig.includes("namespace ")) {
                         methods.push({ signature: fullSig, body: bodyOnly, fullText: fullText });
                    }
                }
            }
            return methods;
        }

        function findMatchingBrace(text, startIndices) {
            let depth = 0;
            for (let i = startIndices; i < text.length; i++) {
                if (text[i] === '{') depth++;
                else if (text[i] === '}') {
                    depth--;
                    if (depth === 0) return i;
                }
            }
            return -1;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Modal ---
        window.openMethodDetail = function(sig) {
            // Revert HTML escape for lookup
            let realSig = sig.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#039;/g, "'");
            
            const { map1, map2 } = window.lastMethodData;
            const m1 = map1.get(realSig);
            const m2 = map2.get(realSig);
            
            document.getElementById('modal-title').innerText = realSig;
            document.getElementById('method-modal').classList.remove('hidden');

            const t1 = m1 ? m1.fullText : '';
            const t2 = m2 ? m2.fullText : '';

            // Update Monaco in Modal
            modalDiffEditor.setModel({
                original: monaco.editor.createModel(t1, 'csharp'),
                modified: monaco.editor.createModel(t2, 'csharp')
            });
            
            // Important: Layout needs refresh when modal appears
            setTimeout(() => modalDiffEditor.layout(), 100);
        };

        window.closeModal = function() {
            document.getElementById('method-modal').classList.add('hidden');
        };
        
        document.getElementById('method-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

    </script>
</body>
</html>
